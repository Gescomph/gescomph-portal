<div class="container">
  <div class="stepper-wrapper">

    <!-- FORMULARIO RAÍZ -->
    <form [formGroup]="form" class="tenant-form modal-form-container" novalidate>

      <mat-horizontal-stepper #stepper class="card shadow p-4" [linear]="true">

        <!-- ============================================================
             PASO 1 — UBICACIÓN
        ============================================================ -->
        <mat-step [stepControl]="locationGroup">
          <mat-dialog-content class="dialog-content modal-form">

            <ng-template matStepLabel>Ubicación</ng-template>

            <div class="modal-section-header">
              <h3>Información Geográfica</h3>
            </div>

            <div class="form-grid" formGroupName="location">

              <!-- Departamento -->
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Departamento</mat-label>
                <mat-select formControlName="departmentId" required [compareWith]="compareById">
                  <mat-option *ngFor="let d of (departments$ | async) ?? []" [value]="d.id">
                    {{ d.name }}
                  </mat-option>
                </mat-select>
                <mat-error *ngIf="locationGroup.get('departmentId')?.hasError('required')">
                  Por favor seleccione el departamento de residencia
                </mat-error>
              </mat-form-field>

              <!-- Ciudad -->
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Ciudad</mat-label>
                <mat-select formControlName="cityId" required [compareWith]="compareById">

                  <mat-option [value]="null" disabled>Selecciona una ciudad…</mat-option>

                  <mat-option
                    *ngIf="locationGroup.get('departmentId')?.value && !loadingCities && (((cities$ | async)?.length ?? 0) === 0)"
                    disabled>
                    No hay ciudades disponibles para este departamento
                  </mat-option>

                  <mat-option *ngFor="let c of (cities$ | async) ?? []" [value]="c.id">
                    {{ c.name }}
                  </mat-option>
                </mat-select>

                <mat-error *ngIf="locationGroup.get('cityId')?.hasError('required')">
                  Por favor seleccione una ciudad válida
                </mat-error>
              </mat-form-field>
            </div>

            <!-- Acciones del paso -->
            <div class="step-actions">
              <app-standard-button
                text="Cancelar"
                variant="stroked"
                (clicked)="cancel()"
                [disabled]="isLoading">
              </app-standard-button>

              <app-standard-button
                text="Siguiente"
                variant="raised"
                color="primary"
                icon="arrow_forward"
                [disabled]="locationGroup.invalid || isInitializing || isLoading"
                (clicked)="stepper.next()">
              </app-standard-button>
            </div>

          </mat-dialog-content>
        </mat-step>

        <!-- ============================================================
             PASO 2 — DATOS PERSONALES
        ============================================================ -->
        <mat-step [stepControl]="personGroup">

          <ng-template matStepLabel>Datos personales</ng-template>

          <div class="modal-section-header">
            <h3>Información Personal</h3>
          </div>

          <div formGroupName="person">

            <div class="form-grid two-cols">

              <!-- Nombre -->
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Nombres</mat-label>
                <input matInput formControlName="firstName" />
                <mat-error *ngIf="personGroup.get('firstName')?.hasError('required')">
                  Por favor ingrese los nombres del arrendatario
                </mat-error>
              </mat-form-field>

              <!-- Apellido -->
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Apellidos</mat-label>
                <input matInput formControlName="lastName" />
                <mat-error *ngIf="personGroup.get('lastName')?.hasError('required')">
                  Por favor ingrese los apellidos del arrendatario
                </mat-error>
              </mat-form-field>

            </div>

            <div class="form-grid two-cols">

              <!-- Teléfono -->
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Teléfono</mat-label>
                <input matInput formControlName="phone" />
                <mat-error *ngIf="personGroup.get('phone')?.hasError('required')">
                  El teléfono es obligatorio
                </mat-error>
              </mat-form-field>

              <!-- Documento -->
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Documento</mat-label>
                <input
                  matInput
                  appDocumentFormat
                  formControlName="document"
                  placeholder="1.234.567"
                  maxlength="14"
                  inputmode="numeric" />
              </mat-form-field>

            </div>

            <!-- Dirección -->
            <div class="form-grid">
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Dirección</mat-label>
                <input matInput formControlName="address" />
                <mat-error *ngIf="personGroup.get('address')?.hasError('required')">
                  La dirección es obligatoria
                </mat-error>
              </mat-form-field>
            </div>

          </div>

          <!-- Acciones -->
          <div class="step-actions">
            <app-standard-button
              text="Cancelar"
              variant="stroked"
              (clicked)="cancel()"
              [disabled]="isLoading">
            </app-standard-button>

            <app-standard-button
              text="Volver"
              icon="arrow_back"
              variant="flat"
              (clicked)="stepper.previous()"
              [disabled]="isLoading">
            </app-standard-button>

            <app-standard-button
              text="Siguiente"
              icon="arrow_forward"
              variant="raised"
              color="primary"
              [disabled]="personGroup.invalid || isInitializing || isLoading"
              (clicked)="stepper.next()">
            </app-standard-button>
          </div>

        </mat-step>

        <!-- ============================================================
             PASO 3 — CUENTA Y ROL
        ============================================================ -->
        <mat-step [stepControl]="accountGroup">

          <ng-template matStepLabel>Cuenta</ng-template>

          <div class="modal-section-header">
            <h4>Información de Acceso</h4>
          </div>

          <div class="form-grid" formGroupName="account">

            <!-- Email -->
            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Email</mat-label>
              <input matInput type="email" formControlName="email" />
              <mat-error *ngIf="accountGroup.get('email')?.hasError('required')">
                El correo es obligatorio
              </mat-error>
            </mat-form-field>

            <!-- Rol -->
            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Rol</mat-label>
              <mat-select [formControl]="roleIdCtrl">
                <mat-option *ngFor="let r of (roles$ | async) ?? []" [value]="r.id">
                  {{ r.name }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="roleIdCtrl.hasError('required')">
                Por favor seleccione un rol
              </mat-error>
            </mat-form-field>

          </div>

          <!-- Acciones finales -->
          <div class="step-actions">
            <app-standard-button
              text="Cancelar"
              variant="stroked"
              (clicked)="cancel()"
              [disabled]="isLoading">
            </app-standard-button>

            <app-standard-button
              text="Volver"
              icon="arrow_back"
              variant="flat"
              (clicked)="stepper.previous()"
              [disabled]="isLoading">
            </app-standard-button>

            <app-standard-button
              [text]="isEdit ? 'Actualizar' : 'Crear'"
              icon="save"
              variant="raised"
              color="primary"
              [disabled]="form.invalid || isInitializing || isLoading"
              [loading]="isLoading"
              (clicked)="submit()">
            </app-standard-button>
          </div>

        </mat-step>

      </mat-horizontal-stepper>

    </form>

  </div>
</div>
