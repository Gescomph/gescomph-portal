<!-- ===========================
   PANEL DEL ADMINISTRADOR
=========================== -->
<ng-container *appHasRoleAndPermission="['Administrador']">
  <section id="dashboard-hero" class="dashboard-hero mb-4">
    <div class="d-flex justify-content-between align-items-end flex-wrap gap-3">
      <div>
        <h2 class="fw-bold mb-1">Panel Principal</h2>
        <p class="text-muted mb-0">Prioriza ingresos, disponibilidad y fuerza contractual en un solo vistazo.</p>
      </div>
    </div>
  </section>

  <!-- Tarjetas estadísticas -->
    <div class="row g-3 mb-4">
    <div id="card-locales-registrados" class="col-12 col-md-6 col-xl-3">
      <app-card-info
        title="Locales registrados"
        [value]="activeEstablishment() + inactiveEstablishment()"
        subtitle="Portafolio total bajo gestión">
      </app-card-info>
    </div>

    <div id="card-locales-ocupados" class="col-12 col-md-6 col-xl-3">
      <app-card-info
        title="Locales ocupados"
        [value]="activeEstablishment()"
        subtitle="Búsqueda de renovaciones">
      </app-card-info>
    </div>

    <div id="card-locales-disponibles" class="col-12 col-md-6 col-xl-3">
      <app-card-info
        title="Locales disponibles"
        [value]="inactiveEstablishment()"
        subtitle="Listos para nuevos contratos">
      </app-card-info>
    </div>

    <div id="card-contratos-activos" class="col-12 col-md-6 col-xl-3">
      <app-card-info
        title="Contratos activos"
        [value]="activeContract()"
        subtitle="Seguimiento semanal">
      </app-card-info>
    </div>
  </div>

  <!-- Quick Action -->
  <div class="row g-3 mb-4">
    <div class="col-12 col-lg-8">
      <div id="quick-action" class="card h-100 p-3">
        <app-quick-action></app-quick-action>
      </div>
    </div>

    <!-- Próximas citas -->
    <div id="upcoming-appointments" class="col-12 col-lg-4">
      <div class="card h-100">
        <div class="card-header">
          <h3 class="h6 mb-0">Próximas citas</h3>
          <small class="text-muted">Organiza la atención y asignaciones</small>
        </div>

        <ng-container *ngIf="upcomingAppointments().length > 0; else noAppointments">
          <div class="card-body d-flex flex-column gap-3" id="upcoming-appointments-list">

            <div *ngFor="let appointment of upcomingAppointments()"
              class="d-flex justify-content-between align-items-start border-bottom pb-2">
              <div>
                <strong>{{ appointment.personName }}</strong>
                <p class="mb-0 text-muted small">
                  {{ appointment.establishmentName }} · {{ appointment.appointmentDate | date:'dd MMM, HH:mm' }}
                </p>
              </div>
              <span class="badge bg-secondary">{{ appointment.appointmentDate | date:'HH:mm' }}</span>
            </div>

            <small class="text-muted">Se muestran las tres citas más cercanas.</small>
          </div>
        </ng-container>

        <ng-template #noAppointments>
          <div class="card-body">
            <p class="text-muted mb-0 small">No hay citas próximas registradas.</p>
          </div>
        </ng-template>
      </div>
    </div>
  </div>

  <!-- Contratos próximos a vencer + gráfica -->
  <div id="contracts-and-chart" class="row g-3 mb-4">

    <!-- Contratos próximos a vencer -->
    <div id="expiring-contracts" class="col-12 col-lg-4">
      <div class="card h-100">
        <div class="card-header">
          <h3 class="h6 mb-0">Contratos próximos a vencer</h3>
          <small class="text-muted">Concentrado en los siguientes 60 días</small>
        </div>

        <ng-container *ngIf="expiringContracts().length > 0; else noContracts">
          <div id="expiring-contracts-list" class="card-body d-flex flex-column gap-3">

            <div *ngFor="let contract of expiringContracts()"
              class="d-flex justify-content-between align-items-start border-bottom pb-2">
              <div>
                <strong>{{ contract.fullName }}</strong>
                <p class="mb-0 text-muted small">
                  Vence: {{ contract.endDateValue | date:'dd MMM' }}
                </p>
              </div>
              <span class="text-primary fw-bold">{{ contract.remainingDays }} días</span>
            </div>

            <small class="text-muted">Prioriza las renovaciones urgentes.</small>
          </div>
        </ng-container>

        <ng-template #noContracts>
          <div class="card-body">
            <p class="text-muted mb-0 small">No hay contratos activos próximos a vencer.</p>
          </div>
        </ng-template>
      </div>
    </div>

    <!-- Gráfica -->
    <div id="income-chart-card" class="col-12 col-lg-8">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div>
            <h3 class="h6 mb-0">Tendencia de ingresos</h3>
            <small class="text-muted">6 meses monitoreados</small>
          </div>
          <span class="badge bg-primary rounded-pill">Ingresos</span>
        </div>

        <div class="card-body">
          <app-line-chart
            id="income-line-chart"
            [title]="'Ingresos mensuales'"
            [labels]="obligationsLabels()"
            [data]="obligationsData()">
          </app-line-chart>

          <div class="d-flex justify-content-between mt-3">
            <small class="text-muted">Último mes</small>
            <strong id="latest-income">{{ latestIncomeMonth() | number:'1.0-0' }}</strong>
          </div>

          <div class="d-flex justify-content-between">
            <small class="text-muted">Total últimos 6 meses</small>
            <strong id="six-month-income">{{ sixMonthIncome() | number:'1.0-0' }}</strong>
          </div>
        </div>
      </div>
    </div>

  </div>
</ng-container>


<!-- ===========================
   PANEL DEL ARRENDADOR (MEJORADO FINAL)
=========================== -->
<ng-container *appHasRoleAndPermission="['Arrendador']">

  <section class="dashboard-hero mb-4">
    <div>
      <h2 class="fw-bold mb-1">Mi Panel</h2>
      <p class="text-muted mb-0">Contratos, renovaciones y accesos rápidos.</p>
    </div>
  </section>

  <!-- FILA 1: 2 CARDS ARRIBA, NO TAN SEPARADAS -->
  <div class="d-flex gap-3 mb-4 flex-wrap">

    <div style="flex:1; min-width:260px; max-width:350px;">
      <app-card-info
        title="Contratos activos"
        [value]="activeContract()"
        subtitle="Vigentes al día de hoy">
      </app-card-info>
    </div>

    <div style="flex:1; min-width:260px; max-width:350px;">
      <app-card-info
        title="Contratos por vencer"
        [value]="expiringContractsForTenant().length"
        subtitle="Próximos 60 días">
      </app-card-info>
    </div>

  </div>

  <!-- FILA 2: ACCIONES RÁPIDAS + CONTRATOS POR VENCER EN LA MISMA FILA -->
  <div class="row g-3 mb-4">

    <!-- Quick Actions -->
    <div class="col-12 col-lg-6">
      <app-quick-action
        [actions]="[
          { label: 'Contratos', style: 'btn-outline-success', RouterLink: '../contracts' },
          { label: 'Establecimientos', style: 'btn-outline-success', RouterLink: '../establishments/main' }
        ]">
      </app-quick-action>
    </div>

    <!-- Tabla contratos próximos a vencer -->
    <div class="col-12 col-lg-6">
      <div class="card h-100">
        <div class="card-header">
          <h3 class="h6 mb-0">Contratos próximos a vencer</h3>
          <small class="text-muted">Renovaciones en los próximos 60 días</small>
        </div>

        <ng-container *ngIf="expiringContractsForTenant().length > 0; else noTenantContracts">
          <div class="card-body d-flex flex-column gap-3">

            <div *ngFor="let contract of expiringContractsForTenant()"
              class="d-flex justify-content-between align-items-start border-bottom pb-2">

              <div>
                <strong>{{ contract.fullName }}</strong>
                <p class="mb-0 text-muted small">
                  Vence: {{ contract.endDate | date:'dd MMM' }}
                </p>
              </div>

              <span class="text-primary fw-bold">{{ contract.remainingDays }} días</span>

            </div>

            <small class="text-muted">Gestiona tu renovación antes del vencimiento.</small>

          </div>
        </ng-container>

        <ng-template #noTenantContracts>
          <div class="card-body">
            <p class="text-muted small mb-0">No tienes contratos próximos a vencer.</p>
          </div>
        </ng-template>
      </div>
    </div>

  </div>

</ng-container>
