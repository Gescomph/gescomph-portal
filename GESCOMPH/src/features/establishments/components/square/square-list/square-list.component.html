<div class="container mt-4">

  <!-- üîç BUSCADOR + BOT√ìN NUEVO -->
  <div class="controls-container">
    <mat-form-field id="squares-search" class="search-field" appearance="outline">
      <mat-icon matPrefix>search</mat-icon>
      <input matInput placeholder="Buscar‚Ä¶" [formControl]="filterControl" type="text" />
    </mat-form-field>

    <!-- üë§ Bot√≥n Nueva plaza (solo visible si el usuario tiene permiso CREAR) -->
    <ng-container *appHasRoleAndPermission="'Administrador'; perms: 'CREAR'">
      <app-standard-button id="squares-new-btn" text="Nueva plaza" variant="raised" color="primary" icon="add"
        iconPosition="left" (clicked)="onCreate()" [disabled]="loading()">
      </app-standard-button>
    </ng-container>
  </div>

  <!-- üåÄ Loading -->
  <ng-container *ngIf="loading(); else content">
    <div class="d-flex justify-content-center mt-4">
      <mat-spinner></mat-spinner>
    </div>
  </ng-container>

  <!-- üì¶ Contenido cuando NO est√° cargando -->
  <ng-template #content>
    <ng-container *ngIf="filteredSquares().length > 0; else noSquares">
      <div id="squares-cards">

        <!-- VISTA ADMINISTRADOR: Con toggle de estado -->
        <ng-container *appHasRoleAndPermission="'Administrador'">
          <app-card *ngFor="let plaza of pagedSquares(); trackBy: trackById" [resource]="plaza" [showViewMore]="false"
            [showViewButton]="false" [showAvailableTag]="false" [toggleConfig]="{
              checked: plaza.active,
              label: plaza.active ? 'Activo' : 'Inactivo',
              disabled: isBusy(plaza.id)
            }" class="plaza-card" (click)="onPlazaCardClick(plaza.id)"
            (toggleChanged)="onToggleActive(plaza.id, $event)" (delete)="onDelete(plaza)" (edit)="onEdit(plaza)">
          </app-card>
        </ng-container>

        <!-- VISTA ARRENDATARIO: Sin toggle, con bot√≥n de acci√≥n expl√≠cito -->
        <ng-container *appHasRoleAndPermission="'Arrendador'">
          <app-card *ngFor="let plaza of pagedSquares(); trackBy: trackById" [resource]="plaza" [showViewMore]="true"
            [showViewButton]="true" [showAvailableTag]="false" [toggleConfig]="null" class="plaza-card"
            (click)="onPlazaCardClick(plaza.id)" (view)="onPlazaCardClick(plaza.id)">
          </app-card>
        </ng-container>
      </div>

      <!-- üìÑ Paginaci√≥n -->
      <mat-paginator id="squares-paginator" [length]="filteredSquares().length" [pageSize]="pageSize"
        [pageSizeOptions]="[6, 12, 18]" [pageIndex]="pageIndex" showFirstLastButtons (page)="onPage($event)">
      </mat-paginator>
    </ng-container>
  </ng-template>

  <!--  Si no hay resultados -->
  <ng-template #noSquares>
    <div class="text-center text-muted mt-4">
      No hay plazas que coincidan con la b√∫squeda.
    </div>
  </ng-template>

  <!-- Template personalizado para la columna 'Estado' -->
  <ng-template #estadoTemplate let-row>
    <div class="d-inline-flex align-items-center gap-3 flex-nowrap">
      <span class="badge align-middle" [ngClass]="row.active ? 'badge-success-solid' : 'badge-warning'">
        {{ row.active ? 'Activo' : 'Inactivo' }}
      </span>

      <div *appHasRoleAndPermission="'Administrador'; perms: 'EDITAR'">
        <app-toggle-button-component class="align-middle" [checked]="!!row?.active"
          [disabled]="loading() || isBusy(row?.id)" (changed)="onToggleActive(row?.id, $event)" [size]="20"
          [onColor]="'#388E3C'" [offColor]="'#9CA3AF'" [thumb]="'#ffffff'">
        </app-toggle-button-component>
      </div>
    </div>
  </ng-template>

</div>